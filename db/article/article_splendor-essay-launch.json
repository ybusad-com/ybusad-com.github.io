{"code":0,"msg":"ok","data":{"article":{"authorCode":"admin","authorName":"孙天骁","classify":"技术类","content":"<p><img src=\"/article/d0c375c8018751d32a.jpg\"></p><p><br></p><p>\t\t两年前，我提出了“光辉号”骁之屋的概念，希望以更新的技术，对个人网站进行进一步的完善，直到它可以承载我的所有期望。而随记系统是这个个人网站非常核心的功能。因为有随记系统的存在，网站才可以跟每天的生活建立亲密的联系，逐步成为其他人了解我和我管理我的绝佳平台。</p><p>\t\t光辉号骁之屋的开发进度比较慢，但我在其上投入了巨大的精力。去年6月，光辉号架构和用户系统后端上线；去年11月，文章系统上线；12月，新版关于页上线。而终于到了今年的5月，我才可以将随记系统奉上。为了做好随记系统，我做出了巨大的努力。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（一）splendor-ui 升级</strong></p><p>\t\tsplendor-ui 是我为了构建光辉号骁之屋前端所自研的、基于Vue3的组件库。从今年1月开始，为了承载随记系统的复杂交互，我首先是继续完善这个组件库。Mention（提供提及功能的文本框）、Swiper（提供轮播图）、InfiniteScroll（提供列表向下加载）、Preview（提供大图预览）等组件陆续就位。同时最主要的，就是DatePicker（日期选择器）的实现。</p><p>\t\t<a href=\"https://splendor-ui.ybusad.com/docs/components/datepicker/index.html\" target=\"_blank\">https://splendor-ui.ybusad.com/docs/components/datepicker/index.html</a></p><p>\t\tDatePicker 是我构建复杂Vue3组件的又一挑战，内部由4个子组件组成。为了简化日期操作，避免出错，DatePicker 使用了 date-fns 处理日期，实现了十余个常见的API，如对日期可选/不可选的控制等。</p><p>\t\t此外，我将组件库从之前的 webpack 迁入了 rollup 打包。rollup 比较适合打包组件库，打出的代码更干净。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（二）前端工程的完善</strong></p><p>\t\t起初在规划光辉号骁之屋前端技术的时候，我将桌面端和移动端分成了两个前端仓库，都使用 Vue3 实现。但作为同一个网站，肯定会有很多共同代码。于是我在进一步建设中，将两个仓库抽了一个公用的 common 文件夹作为 git submodule 管理。内含许多的公共函数、常量、样式等。未来也可以考虑抽一些公用组件进去，但目前因为考虑桌面版和手机版在交互上调用的某些方法不同（比如提示），所以暂未抽取。新增了很多方便的钩子函数，比如 useIsLogin() 可以返回一个代表是否登录的 ref，useQuery() 可以监测某个页面 query 参数的变化等等。它们方便了我开发更复杂的交互。</p><p>\t\t在 Node 层面，也新加入了一些很棒的能力。比如 Node 直传七牛云的能力、与小程序相关的获取AccessToken、内容检查、甚至生成小程序码的能力。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（三）思考和实践</strong></p><p>\t\t为了更好记录生活承载生活，要补齐哪些现有随记系统的不足，要做出哪些升级改进，这次又应该优先实现什么功能，是我从要开始做之前就要思考的问题。我对随记系统未来比较希望具有的功能有支持分词模糊搜索、支持更好的权限控制、更好的数据统计功能、有智能推荐功能，实现订阅推送等等。但这些功能实现起来并不容易。所以这次主要还是为未来的这些功能要打一个好的底子。这次新增的功能主要有<strong>随记标签功能</strong>（未来可能会发展成事件系统）、<strong>多时区支持</strong>（在其他国家发布随记时，要在时间显示上有所区分）、<strong>随记地图缓存功能</strong>。随记地图缓存功能来源于以前我的一个担忧，在几十年后访问几十年前的随记，当初的定位现今已经面目全非，已经早就不再是随记当初发送时的那个场所。如果可以让携带定位的随记缓存一个当时的地图，这样就算几十年后，我也就能回溯当初发表这条随记的时候，附近都有什么。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（四）界面设计</strong></p><p>\t\t在功能没有破坏性改变的情况下，界面也不会有太大的改动。但是需要在此前的基础上做优化。随记系统的两个大页面，就是首页和详情页。首页主要优化了搜索时的交互。之前的随记搜索体验我感觉不算太好（尤其是选择时间段的时候），这次有了自研组件，体验会比之前好了。随记条目的排版参照了小程序的排版，我觉得小程序的排版做的算比较好的。</p><p><img src=\"/article/5718dc16dbb6742428.jpg\"></p><p>\t\t搜索也支持以前有的排除关键词搜索能力和地点搜索能力。这次设计成搜索框获得焦点的时候，其余选项才会展开。这样比以前更兼顾美感和功能。刷新按钮移到了左上角作为一个悬浮按钮，原来是放在导航栏上。</p><p><img src=\"/article/d7e4f25bbf42b21cf9.jpg\"></p><p>\t\t新增了一个名为“趋势”的图表，可以简单显示过去六周发布随记数量的变化。进而也可以看出我的生活是趋于枯燥还是趋于精彩。这个图表是使用 <a href=\"https://github.com/ghalex/vue3-charts\" target=\"_blank\">vue3-charts</a> 做的。</p><p>\t\t随记的右上角新增了一个菜单，内可操作浏览详情、分享随记和屏蔽随记。分享随记会有一个弹窗，会生成一个小程序码，可以扫码进入小程序然后分享，或者直接将小程序码复制给他人。屏蔽随记是一个可供他人操作隐藏争议随记的功能，需要登录后操作。操作屏蔽随记后，这条随记会转为私有随记，并在后台生成一条日志。对于我来说，编辑随记的按钮也放在这里。</p><p class=\"ql-align-center\"><img src=\"/article/fbbfc896e2aa6d2b3a.jpg\"></p><p>\t\t随记详情页的设计，我曾经画过一些草稿，供实现时参考。</p><p><img src=\"/article/16c5ed8e684b4d96dc.jpg\"></p><p>\t\t这个草稿主要体现了：撰写随记窗口使用导航栏左侧的按钮触发，导航栏的最近随记预览小窗，左右快速翻动随记（暂未实现），和其他希望有的功能。我最终的实现效果参考如下：</p><p><img src=\"/article/11d0277d1b3fdeed1c.jpg\"></p><p>\t\t地图分为两部分，左边是动态的百度地图，可以移动放大缩小，右边就是缓存的静态地图，可以鼠标点击放大。我已经为所有携带坐标的随记都刷了今天的地图。</p><p>\t\t之前展示的发送设备等发送来源的信息，我归到了右上角菜单-查看源信息里。可以看到一些随记的详细参数，例如发送时间和实际创建时间等。</p><p>\t\t左侧日期选择终于支持了左右翻动。这个如果是用element-ui之类的组件库，是不方便实现的，也是我之前的网站没有实现的原因之一。同时手机版网页也支持了这一功能，之前的手机版连选择日期都是不支持的。</p><p><img src=\"/article/beb724e19fb92f1905.jpg\"></p><p>\t\t写了新架构下的 emoji 选择器；提及人的推荐列表添加了权重排序算法；评论支持以错落的方式展示回复关系。当然目前的实现还不算完美，支持了错落展示之后，暂时还不支持评论数量很多。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（五）后台管理系统</strong></p><p>\t\t这次也是大幅升级了后台管理系统。分为两个Part，访问日志和数据统计。其中数据统计接入了图标，是使用阿里的 bizcharts 实现的。</p><p><img src=\"/article/75f9ac7118b0708a51.jpg\"></p><p>\t\t访问记录就是可以查询来自小程序和网页的访问记录。我就可以知道一天有多少人访问了我的随记。另外针对这个后台管理的前端应用（splendor-pc-admin），我给它做了多页改造。于是它现在是一个多页应用，这样更接近了有赞微商城的开发体验。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（六）随记阅览小程序</strong></p><p>\t\t为了保证新架构上线时小程序平滑过渡，我提前两个星期就做了小程序的改动。将小程序的调用接口先转到Node。在新架构上线之前，由Node转发PHP服务。上线之后，就直接由相应的接口调用Go服务提供服务了。此外，主要的改动还有：增加了随记标签和时区的展示能力；适配了微信小程序夜间模式；适配了随记详情页的转发到朋友圈。随记小程序在这两年给我带来了很多流量，确实也算是一个得意作品了。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（七）App 的改动</strong></p><p>\t\t随记主要是通过我的一个Android应用程序来实现随时随地，随想随记的。我在2016年完成了这个客户端的6.0版本，带来了随记发送队列等一系列实用的功能。在那之后我基本就没有大改过，这次是16年之后改动最大的一次。首先我升级了它的targetSdk版本，之前适配的是Android7，这次我需要适配Android11。这个升级带来了许许多多的问题，一一解决之。比如重写了拍摄照片的逻辑，因为从Android10开始，文件存储机制有了类似于iOS的大变化，总之我不能像以前那样把图片存储到手机里的一个特定文件夹里了。然后重写了网络请求逻辑以适配新的架构。我用上了安卓推荐的Volley来发送请求，它的好处是使用简单而且省电。但问题是不能发送大量数据。因此我把随记配图的上传搬到了客户端完成（接了七牛sdk）。之前是在服务端完成的。然后新增了一个登录界面。之前的版本我是把凭据写死在应用里的，这样做是不太安全的，并且之前也出现过程序泄露导致网站出现未知来源随记的结果。做了登录界面之后，登录态就可以和其他接口一样统一了。</p><p><img src=\"/article/03ee53f5f58ac52af7.jpg\"></p><p>\t\t接着就是支持选择标签。只有 App 能方便快速地选择随记标签，这样我以后才能更有动力利用好这一新功能。因为目前的界面很简洁高效，我不想再胡乱添加什么额外元素。于是我绞尽脑汁之后，在随记发送菜单内添加了一项新菜单“选择标签并发送…”，点开之后就可以加载最近使用过的标签，做选择、筛选或新建。我现在非常满意这个设计。同时，App 内的编辑随记也支持了编辑标签的功能。</p><p>\t\t<strong style=\"color:rgb(0, 71, 178);\">（八）其他</strong></p><p>\t\t因为百科排行榜的计算是依赖随记系统的，所以这次也把排行榜的计算逻辑移到了 Go 去处理。而且是靠算法而不是靠查库完成的计算。我惊喜地发现这样做的话，计算速度已经到了毫秒的级别，是比之前快几十倍乃至几百倍的。这样的话其实做缓存就是个可选项的，但考虑到计算过程可能会占用内存，我还是做了缓存。</p><p>\t\t<strong style=\"color:rgb(0, 102, 204);\">（九）未来</strong></p><p>\t\t随记系统上线之后，后面的重心就应该放在现在的用户系统和消息系统的升级了。这主要是前端的工作量，用户系统的交互逻辑是有很大文章去做的。然后就是首页的重新设计。我真希望可以尽快看到网站焕然一新的那一天。当然也会花一些时间继续优化随记系统。待新版首页上线之后，应该就会有时间再为随记系统加更高级的功能了。</p><p>\t\t另外，我现在还压着一个新版导航栏音乐播放器没有上线呢~ 希望等到新版首页上线，网站体验一致性更好时再上线~</p><p>\t\t继续前进，期待下一个里程碑。</p>","createTime":"2021-05-24 00:43:58","customCoverKey":"","id":291,"isGood":true,"isTop":false,"publicState":0,"replyCount":0,"state":0,"tags":["光辉号","随记系统"],"title":"光辉号骁之屋随记系统，上线！","urlCode":"splendor-essay-launch","viewCount":233,"viewGroup":-1,"authPassed":true},"author":{"exists":true,"name":"孙天骁","code":"admin","alias":"stx","description":"一个内心丰富的人","homepageUrl":"/u/stx","group":5,"groupName":"站长","isLocked":false,"gender":1,"avatarUrl":"/s/user/FufL-vSFO5eM1we1mxdfYHKH9tfK.jpg","realName":"孙天骁","refBaike":"","isManager":true,"isMe":true,"isLover":false,"introduction":"","joinTime":"2015-02-11 21:45:00"}}}