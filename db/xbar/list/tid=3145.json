{"code":0,"msg":"ok","data":{"barInfo":{"barName":"骁","description":"开放自由的类贴吧式留言板","isMainBar":true,"isPublic":true},"list":[{"author":"孙天骁","authorCode":"admin","content":"<p><img src=\"/xbar/dd8695174c275f978d.jpg\"></p> ","floor":1,"pid":0,"postTime":"2021-05-27 17:52:23","replyCount":0,"signKey":"","source":"","sourceUrl":"","tid":3145},{"author":"孙天骁","authorCode":"admin","content":"<pre spellcheck=\"false\">&lt;template&gt;\n  &lt;!-- 骁之屋通用头像上传组件，孙天骁于2017-12-18 --&gt;\n  &lt;div class=\"sk-avatar-uploader\"&gt;\n    &lt;form ref=\"form\" @submit.prevent=\"_submit\"&gt;\n      &lt;div class=\"form-group\" v-tooltip=\"'支持 jpg/png 格式'\"&gt;\n        &lt;input\n          type=\"file\"\n          class=\"form-control\"\n          name=\"image-file\"\n          ref=\"file\"\n          accept=\"image/*\"\n          @change=\"fileSelect\"\n          :disabled=\"isBusy\"\n        /&gt;\n      &lt;/div&gt;\n      &lt;el-alert type=\"error\" :title=\"errMsg\" v-show=\"isError\"&gt;&lt;/el-alert&gt;\n      &lt;div class=\"avatar-cropbox\" :class=\"{ prepare: isPrepare }\" ref=\"cropbox\"&gt;\n        &lt;img\n          class=\"pic-preview\"\n          src\n          alt=\"图片加载中……\"\n          ref=\"cropPic\"\n          v-show=\"!isPrepare\"\n        /&gt;\n      &lt;/div&gt;\n      &lt;div class=\"form-group\"&gt;\n        &lt;button\n          type=\"submit\"\n          class=\"btn btn-block btn-primary\"\n          :disabled=\"!isReadyUpload || isError || isBusy\"\n          v-text=\"msg\"\n        &gt;&lt;/button&gt;\n      &lt;/div&gt;\n      &lt;input type=\"hidden\" name=\"x1\" v-model=\"x1\" /&gt;\n      &lt;input type=\"hidden\" name=\"y1\" v-model=\"y1\" /&gt;\n      &lt;input type=\"hidden\" name=\"w\" v-model=\"w\" /&gt;\n      &lt;input type=\"hidden\" name=\"h\" v-model=\"h\" /&gt;\n      &lt;input type=\"hidden\" name=\"piczoom\" v-model=\"picZoom\" /&gt;\n      &lt;input type=\"hidden\" name=\"filesize\" v-model=\"fileSize\" /&gt;\n      &lt;input type=\"hidden\" name=\"filetype\" v-model=\"fileType\" /&gt;\n      &lt;input type=\"hidden\" name=\"filedim\" v-model=\"fileDim\" /&gt;\n    &lt;/form&gt;\n    &lt;el-alert\n      title\n      type=\"info\"\n      v-show=\"!isCarryImage\"\n      :closable=\"false\"\n      show-icon\n    &gt;\n      可通过\n      &lt;a href=\"https://www.cartoonify.de/\" target=\"_blank\"\n        &gt;<a href=\"https://www.cartoonify.de/&lt;/a\" target=\"_blank\">https://www.cartoonify.de/&lt;/a</a>\n      &gt;\n      生成卡通头像。\n    &lt;/el-alert&gt;\n  &lt;/div&gt;\n&lt;/template&gt;\n\n\n&lt;script&gt;\nimport $ from 'jquery';\nimport '../../assets/jcrop/jquery.Jcrop.min.js';\nimport '../../assets/jcrop/jquery.Jcrop.min.css';\nimport fixOrientation from '../plugins/fixOrientation';\n\n\nlet jcrop_api = null;\n\n\nexport default {\n  data() {\n    return {\n      isBusy: false,\n      isPrepare: true,\n      isReadyUpload: false,\n      isCarryImage: false,\n      isError: false,\n      errMsg: '',\n\n\n      x1: 0,\n      y1: 0,\n      w: 0,\n      h: 0,\n      picZoom: 1,\n      fileSize: 0,\n      fileType: '',\n      fileDim: '',\n    };\n  },\n  props: {\n    thumbSize: {\n      type: Number,\n      default: 200,\n    },\n    tokenURL: {\n      type: String,\n      required: true,\n    },\n  },\n  computed: {\n    msg() {\n      if (this.isBusy) return '上传中，请等待';\n      if (this.isReadyUpload) return '确认上传';\n      if (this.isCarryImage) return '请先在图中画出需要截取的部分';\n      return '请先选择文件';\n    },\n  },\n  methods: {\n    destroyJcrop() {\n      if (typeof jcrop_api === 'object' &amp;&amp; jcrop_api !== null) {\n        jcrop_api.destroy();\n        jcrop_api = null;\n      }\n    },\n    reset() {\n      this.isError = this.isReadyUpload = this.isCarryImage = false;\n      this.isPrepare = true;\n      if (this.$refs.cropPic) {\n        this.$refs.cropPic.src = this.$refs.cropPic.style = '';\n      }\n      this.x1 = this.y1 = this.w = this.h = 0;\n      this.destroyJcrop();\n    },\n    fileSelect() {\n      // 还原各组件状态\n      this.reset();\n\n\n      // 检查是否有图片选中\n      const oFile = this.$refs.file.files[0];\n      if (oFile == undefined) return;\n\n\n      // 检查图片格式和大小\n      const rFilter = /^image\\/(jpe?g|png)$/i;\n      if (!rFilter.test(oFile.type)) {\n        this.setError('请选择jpg/png格式的图片');\n        return;\n      }\n      if (oFile.size &gt; 1024 * 1024 * 10) {\n        this.setError('请选择大小在10M内的图片');\n        return;\n      }\n      this.isPrepare = false;\n\n\n      const oImage = this.$refs.cropPic;\n      fixOrientation(oFile)\n        .then((base64, oReader) =&gt; {\n          this.isCarryImage = true;\n\n\n          oImage.src = base64;\n          oImage.onload = () =&gt; {\n            let sResultFileSize = this.bytesToSize(oFile.size);\n            this.fileSize = sResultFileSize;\n            this.fileType = oFile.type;\n            this.fileDim = oImage.naturalWidth + ' x ' + oImage.naturalHeight;\n\n\n            $(oImage).Jcrop(\n              {\n                aspectRatio: 1,\n                bgFade: true,\n                bgOpacity: 0.3,\n                bgColor: 'white',\n                onChange: this.updateInfo,\n                onSelect: this.updateInfo,\n                onRelease: this.clearInfo,\n              },\n              function () {\n                jcrop_api = this; // 这里的this指Jcrop操作对象\n              }\n            );\n          };\n        })\n        .catch((err) =&gt; {\n          this.setError('读取图片失败！');\n          console.error(err);\n        });\n    },\n    updateInfo(e) {\n      this.x1 = e.x;\n      this.y1 = e.y;\n      this.w = e.w;\n      this.h = e.h;\n    },\n    bytesToSize(bytes) {\n      let sizes = ['Bytes', 'KB', 'MB'];\n      if (bytes == 0) return 'n/a';\n      let i = parseInt(Math.floor(Math.log(bytes) / Math.log(1024)));\n      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];\n    },\n    setError(msg) {\n      this.errMsg = msg;\n      this.isError = true;\n      this.isPrepare = true;\n      this.destroyJcrop();\n    },\n    _submit() {\n      if (!this.isReadyUpload) return;\n      this.isBusy = true;\n      let width = parseInt(this.$refs.cropPic.style.width);\n      let naturalWidth = this.$refs.cropPic.naturalWidth;\n      this.picZoom = naturalWidth / width;\n      this.cropImage(this.thumbSize).then(\n        (data) =&gt; {\n          this.uploadQiniu(data.substr(data.indexOf('base64') + 7));\n        },\n        (err) =&gt; {\n          this.$message.error('图片裁切失败，上传未完成');\n          this.isBusy = false;\n          console.error(err);\n        }\n      );\n    },\n    cropImage(thumbSize) {\n      let cropPic = this.$refs.cropPic;\n      let $canvas = $('&lt;canvas/&gt;').attr({\n          width: thumbSize + 'px',\n          height: thumbSize + 'px',\n        }),\n        canvas = $canvas[0];\n      let realX = this.x1 * this.picZoom,\n        realY = this.y1 * this.picZoom;\n      let realW = this.w * this.picZoom,\n        realH = this.h * this.picZoom;\n\n\n      return new Promise((resolve, reject) =&gt; {\n        try {\n          let ctx = canvas.getContext('2d');\n          ctx.fillStyle = 'white';\n          ctx.fillRect(0, 0, thumbSize, thumbSize); // 加入白色背景色\n          ctx.drawImage(\n            cropPic,\n            realX,\n            realY,\n            realW,\n            realH,\n            0,\n            0,\n            thumbSize,\n            thumbSize\n          );\n          resolve(canvas.toDataURL('image/jpeg'));\n        } catch (ex) {\n          reject(ex);\n        }\n      });\n    },\n    uploadQiniu(base64) {\n      this.$http.get(this.tokenURL).then(\n        (res) =&gt; {\n          let token = res.body.token; // 拿到token，把base64数据发给七牛云\n          this.$http\n            .post('//upload.qiniup.com/putb64/-1', base64, {\n              headers: {\n                'Content-type': 'application/octet-stream',\n                Authorization: `UpToken ${token}`,\n              },\n              credentials: false,\n            })\n            .then(\n              (res) =&gt; {\n                let data = res.body; // 拿到七牛云回调，向网站注册头像\n                this.$emit('uploadsuccess', data, (needReset = false) =&gt; {\n                  this.isBusy = false;\n                  if (needReset) {\n                    this.reset();\n                  }\n                }); // 交给父组件处理\n              },\n              (err) =&gt; {\n                this.isBusy = false;\n                this.$notify({\n                  title: '上传失败',\n                  content: '头像上传失败，请重新试一下吧~',\n                  type: 'error',\n                });\n              }\n            );\n        },\n        (err) =&gt; {\n          this.isBusy = false;\n          this.$catchErr(err, (data) =&gt; {\n            this.$message.error(data.msg);\n          });\n        }\n      );\n    },\n  },\n  watch: {\n    w: function (val) {\n      this.isReadyUpload = val &gt; 0;\n    },\n  },\n};\n&lt;/script&gt;\n\n\n&lt;style lang=\"less\"&gt;\ndiv.sk-avatar-uploader {\n  max-width: 768px;\n  margin: 0 auto;\n\n\n  input[type='radio'] {\n    display: none !important;\n  }\n\n\n  div.avatar-cropbox {\n    margin-bottom: 15px;\n\n\n    img.pic-preview {\n      width: 100%;\n    }\n\n\n    &amp;.prepare {\n      min-height: 300px;\n      background: #f1f1f1 url('../../assets/images/preview-tip.png') center\n        no-repeat;\n\n\n      img.pic-preview {\n        width: 100%;\n        min-height: 300px;\n      }\n    }\n  }\n}\n&lt;/style&gt;\n</pre> ","floor":2,"pid":8885,"postTime":"2021-05-27 17:52:53","replyCount":0,"signKey":"","source":"","tid":3145},{"author":"孙天骁","authorCode":"admin","content":"<p>实现上还是用了jQuery。</p><p>要开始做新的了，完全拿掉jQuery。</p> ","floor":3,"pid":8886,"postTime":"2021-05-27 17:53:28","replyCount":0,"signKey":"","source":"","tid":3145},{"author":"孙天骁","authorCode":"admin","content":"<p>以前的代码挺乱的，现在的我不太能忍直视</p><p>所以我才有很大的欲望重构的。</p> ","floor":4,"pid":8887,"postTime":"2021-05-27 21:49:42","replyCount":0,"signKey":"","source":"","tid":3145},{"author":"孙天骁","authorCode":"admin","content":"<p>新版的已经上线啦！</p> ","floor":5,"pid":8888,"postTime":"2021-06-20 21:46:06","replyCount":0,"signKey":"","source":"","tid":3145}],"pageInfo":{"total":5,"pageSize":30,"current":1},"threadInfo":{"author":"孙天骁","authorCode":"admin","classifyName":"技术","goodClassifyName":"","id":3145,"isGood":false,"isPicture":true,"isRepost":false,"postTime":"2021-05-27 17:52:23","replyCount":4,"title":"开源下骁之屋现有的头像上传组件……","topState":0},"tid":3145,"total":5,"totalPages":1,"viewHost":false,"users":{"admin":{"exists":true,"name":"孙天骁","code":"admin","alias":"stx","description":"一个内心丰富的人","homepageUrl":"/u/stx","group":5,"groupName":"站长","isLocked":false,"gender":1,"avatarUrl":"/s/user/FufL-vSFO5eM1we1mxdfYHKH9tfK.jpg","realName":"孙天骁","refBaike":"","isManager":true,"isMe":true,"isLover":false,"introduction":"","joinTime":"2015-02-11 21:45:00"}},"needVerify":true}}